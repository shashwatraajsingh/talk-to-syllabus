"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.UpsertRecordsCommand = void 0;
const errors_1 = require("../../errors");
const utils_1 = require("../../utils");
const db_data_1 = require("../../pinecone-generated-ts-fetch/db_data");
class UpsertRecordsCommand {
    apiProvider;
    config;
    namespace;
    constructor(apiProvider, namespace, config) {
        this.apiProvider = apiProvider;
        this.namespace = namespace;
        this.config = config;
    }
    validator = (options) => {
        for (const record of options.records) {
            if (!record.id && !record._id) {
                throw new errors_1.PineconeArgumentError('Every record must include an `id` or `_id` property in order to upsert.');
            }
        }
    };
    async run(options) {
        const fetch = (0, utils_1.getFetch)(this.config);
        this.validator(options);
        const namespace = options.namespace ?? this.namespace;
        const hostUrl = await this.apiProvider.provideHostUrl();
        const upsertRecordsUrl = `${hostUrl}/records/namespaces/${namespace}/upsert`;
        const requestHeaders = {
            'Api-Key': this.config.apiKey,
            'User-Agent': (0, utils_1.buildUserAgent)(this.config),
            'X-Pinecone-Api-Version': db_data_1.X_PINECONE_API_VERSION,
        };
        // Note: This operation uses direct fetch() with NDJSON format,
        // Retries are handled by the wrapped fetch from getFetch()
        const response = await fetch(upsertRecordsUrl, {
            method: 'POST',
            headers: requestHeaders,
            body: toNdJson(options.records),
        });
        if (response.ok) {
            return;
        }
        else {
            const err = await (0, errors_1.handleApiError)(new db_data_1.ResponseError(response, 'Response returned an error'), undefined, upsertRecordsUrl);
            throw err;
        }
    }
}
exports.UpsertRecordsCommand = UpsertRecordsCommand;
function toNdJson(data) {
    return data.map((record) => JSON.stringify(record)).join('\n');
}
//# sourceMappingURL=upsertRecords.js.map