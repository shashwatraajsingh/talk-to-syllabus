"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const update_1 = require("../../vectors/update");
const api_version_1 = require("../../../pinecone-generated-ts-fetch/db_data/api_version");
const setupResponse = (response, isSuccess) => {
    const fakeUpdate = jest
        .fn()
        .mockImplementation(() => isSuccess ? Promise.resolve(response) : Promise.reject(response));
    const VOA = { updateVector: fakeUpdate };
    const VectorProvider = {
        provide: async () => VOA,
    };
    const cmd = new update_1.UpdateCommand(VectorProvider, 'namespace');
    return { fakeUpdate, VOA, VectorProvider, cmd };
};
const setupSuccess = (response) => {
    return setupResponse(response, true);
};
describe('update', () => {
    test('calls the openapi update endpoint, passing target namespace', async () => {
        const { fakeUpdate, cmd } = setupSuccess('');
        const returned = await cmd.run({
            id: 'fake-vector',
            values: [1, 2, 3, 4, 5],
            sparseValues: {
                indices: [15, 30, 25],
                values: [0.5, 0.5, 0.2],
            },
            metadata: { genre: 'ambient' },
        });
        expect(returned).toBe(void 0);
        expect(fakeUpdate).toHaveBeenCalledWith({
            updateRequest: {
                namespace: 'namespace',
                id: 'fake-vector',
                values: [1, 2, 3, 4, 5],
                sparseValues: {
                    indices: [15, 30, 25],
                    values: [0.5, 0.5, 0.2],
                },
                setMetadata: { genre: 'ambient' },
            },
            xPineconeApiVersion: api_version_1.X_PINECONE_API_VERSION,
        });
    });
    test('throws error if no id or filter are provided', async () => {
        const { cmd } = setupSuccess('');
        const toThrow = async () => {
            // @ts-ignore
            await cmd.run({
                values: [1, 2, 3, 4, 5],
                sparseValues: { indices: [15, 30, 25], values: [0.5, 0.5, 0.2] },
                metadata: { genre: 'ambient' },
            });
        };
        await expect(toThrow()).rejects.toThrowError('You must pass a non-empty string for the `id` field or a `filter` object in order to update records.');
    });
    test('throws error if both id and filter are provided', async () => {
        const { cmd } = setupSuccess('');
        const toThrow = async () => {
            await cmd.run({
                id: 'abc',
                filter: { genre: 'ambient' },
            });
        };
        await expect(toThrow()).rejects.toThrowError('You cannot pass both an `id` and a `filter` object to update records. Use either `id` to update a single record, or `filter` to update multiple records.');
    });
    test('uses namespace from options when provided', async () => {
        const { fakeUpdate, cmd } = setupSuccess('');
        await cmd.run({
            id: 'fake-vector',
            values: [1, 2, 3],
            namespace: 'custom-namespace',
        });
        expect(fakeUpdate).toHaveBeenCalledWith({
            updateRequest: {
                namespace: 'custom-namespace',
                id: 'fake-vector',
                values: [1, 2, 3],
                sparseValues: undefined,
                setMetadata: undefined,
                filter: undefined,
            },
            xPineconeApiVersion: api_version_1.X_PINECONE_API_VERSION,
        });
    });
});
//# sourceMappingURL=update.test.js.map