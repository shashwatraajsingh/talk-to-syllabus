"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.modelValidation = exports.messagesValidation = exports.validateChatOptions = exports.chat = void 0;
const assistant_data_1 = require("../../pinecone-generated-ts-fetch/assistant_data");
const errors_1 = require("../../errors");
const chat = (assistantName, apiProvider) => {
    return async (options) => {
        (0, exports.validateChatOptions)(options);
        const api = await apiProvider.provideData();
        const messages = (0, exports.messagesValidation)(options);
        const model = (0, exports.modelValidation)(options);
        return await api.chatAssistant({
            xPineconeApiVersion: assistant_data_1.X_PINECONE_API_VERSION,
            assistantName: assistantName,
            chatRequest: {
                messages: messages,
                stream: false,
                model: model,
                filter: options.filter,
                jsonResponse: options.jsonResponse,
                includeHighlights: options.includeHighlights,
                contextOptions: {
                    topK: options.contextOptions?.topK,
                    snippetSize: options.contextOptions?.snippetSize,
                    multimodal: options.contextOptions?.multimodal,
                    includeBinaryContent: options.contextOptions?.includeBinaryContent,
                },
            },
        });
    };
};
exports.chat = chat;
const validateChatOptions = (options) => {
    if (!options || !options.messages) {
        throw new errors_1.PineconeArgumentError('You must pass an object with required properties (`messages`) to chat with an assistant.');
    }
    if (options.model && typeof options.model !== 'string') {
        throw new errors_1.PineconeArgumentError(`Invalid model: "${options.model}". Must be a string.`);
    }
};
exports.validateChatOptions = validateChatOptions;
/**
 * Validates the messages passed to the Assistant.
 *
 * @param options - A {@link ChatRequest} object containing the messages to send to the Assistant.
 * @throws An Error `role` key is not one of `user` or `assistant`.
 * @throws An Error if the message object does not have exactly two keys: `role` and `content`.
 * @returns An array of {@link MessageModel} objects containing the messages to send to the Assistant.
 */
const messagesValidation = (options) => {
    let messages = [];
    // If messages are passed as a list of strings:
    if (options.messages && typeof options.messages[0] == 'string') {
        // role defaults to user if not specified
        messages = options.messages.map((message) => {
            return { role: 'user', content: message };
        });
    }
    // If messages are passed as a list of objects:
    if (Array.isArray(options.messages) &&
        typeof options.messages[0] === 'object') {
        if (options.messages[0]['role']) {
            if (options.messages[0]['role'].toLowerCase() !== 'user' &&
                options.messages[0]['role'].toLowerCase() !== 'assistant') {
                throw new errors_1.PineconeArgumentError('No role specified in message object. Must be one of "user" or "assistant"');
            }
        }
        // Extract unique keys from all messages
        const keys = Array.from(new Set(options.messages.flatMap((message) => Object.keys(message))));
        if (keys.length !== 2) {
            throw new errors_1.PineconeArgumentError('Message object must have exactly two keys: "role" and "content"');
        }
        // Cast messages after validating keys
        return (messages = options.messages);
    }
    return messages;
};
exports.messagesValidation = messagesValidation;
/**
 * Validates the model passed to the Assistant.
 *
 * @param options - A {@link ChatOptions} object containing the model to use for the Assistant.
 * @returns The model string to use, defaulting to 'gpt-4o' if not specified.
 */
const modelValidation = (options) => {
    // default to GPT-4o for backward compatibility
    const model = options.model || 'gpt-4o';
    return model;
};
exports.modelValidation = modelValidation;
//# sourceMappingURL=chat.js.map